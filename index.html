<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Buy The Look</title>
<style>
html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
}
body {
  display: flex;
  flex-direction: column;
  position: relative;
  background: #2d2a24;
  color: #fff;
}
    #filters {
        display: flex;
        gap: 10px;
        padding: 10px;
        padding-right: 170px;
        background: #000;
        position: relative;
        z-index: 1000;
        overflow: visible;
      }
  .filter {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: sans-serif;
    font-size: 14px;
  }
    .filter button {
      background: none;
      border: none;
      cursor: pointer;
      font: inherit;
      position: relative;
      width: 60px;
      height: 60px;
      padding: 0;
    }
    .filter button .preview {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: none;
    }
    .filter button .label {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      white-space: pre-line;
      font-size: 12px;
      color: #fff;
    }
    .filter button.selected .preview {
      display: block;
    }
    .filter button.selected .label {
      top: auto;
      bottom: 0;
      left: 0;
      transform: none;
      width: 100%;
      background: rgba(0, 0, 0, 0.5);
      color: #fff;
      padding: 2px 0;
    }
  .filter .options {
    display: none;
    gap: 5px;
    position: absolute;
    top: 100%;
    left: 0;
    background: #403d37;
    flex-direction: column;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
    padding: 10px;
    width: 150px;
    z-index: 1001;
  }
  .filter.open .options {
    display: flex;
  }
.filter .options img {
  width: 120px;
  height: 120px;
  object-fit: cover;
  border: 2px solid transparent;
  cursor: pointer;
}
.filter .options img.selected {
  border-color: #fff;
}
.filter .options img.disabled {
  opacity: 0.3;
  pointer-events: none;
}
#main-display {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 10px;
  background: #2d2a24;
  position: relative;
  z-index: 1;
}
#collage {
  column-count: 3;
  column-gap: 10px;
}
#collage .collage-item > img {
  width: 100%;
  height: auto;
  display: block;
}

.collage-item {
  position: relative;
  margin-bottom: 10px;
  break-inside: avoid;
}

.product-info {
  position: absolute;
  top: 5px;
  left: 5px;
  background: rgba(0, 0, 0, 0.7);
  color: #fff;
  padding: 4px 6px;
  font-weight: normal;
  font-family: sans-serif;
  font-size: 14px;
  line-height: 1.2;
}
.product-info img {
  height: 1em;
  width: auto;
  vertical-align: middle;
  margin-right: 4px;
  display: inline;
}
#logo {
  position: absolute;
  top: 10px;
  right: 10px;
  width: 150px;
  height: auto;
  z-index: 1002;
  pointer-events: none;
}
</style>
</head>
<body>
<img id="logo" src="MoniTTa.png" alt="MoniTTa logo">
<div id="filters"></div>
<div id="main-display">
  <div id="collage"></div>
</div>
<script>
function parseFileName(file) {
  const base = file.replace(/\.[^.]+$/, '');
  const [shotId, ...productParts] = base.split('_p');
  const products = productParts.map(part => {
    const hyphenIndex = part.indexOf('-');
    const underscoreIndex = part.indexOf('_');
    let firstSepIndex;
    if (hyphenIndex === -1) firstSepIndex = underscoreIndex;
    else if (underscoreIndex === -1) firstSepIndex = hyphenIndex;
    else firstSepIndex = Math.min(hyphenIndex, underscoreIndex);
    let num = part;
    let rest = '';
    if (firstSepIndex !== -1) {
      num = part.slice(0, firstSepIndex);
      rest = part.slice(firstSepIndex + 1);
    }
    let type, brand, size, name;
    const tokens = rest.split('_');
    if (tokens.length === 1) {
      const [t, b, s, ...nParts] = rest.split('-');
      type = t; brand = b; size = s; name = nParts.join('-');
    } else {
      type = tokens[0];
      const other = tokens.slice(1).join('_');
      const [b, s, ...nParts] = other.split('-');
      brand = b; size = s; name = nParts.join('-');
    }
    return { number: num, type, brand, size, name, primary: num === '0' };
  });
  return { shotId, file, products };
}

function buildProductImageMap(images) {
  const map = {};
  images.forEach(img => {
    if (img.products.length !== 1) return;
    const p = img.products[0];
    if (!p.primary) return;
    if (!map[p.type]) map[p.type] = {};
    map[p.type][p.brand] = img.file;
  });
  return map;
}

function filterImages(images, selected) {
  return images.filter(img =>
    Object.entries(selected).every(([type, brand]) =>
      !brand || img.products.some(p => p.type === type && p.brand === brand)
    )
  );
}

function updateFilterImages(filters, allImages, selected) {
  Object.entries(filters).forEach(([type, brandMap]) => {
    const tempSelected = { ...selected, [type]: null };
    const filtered = filterImages(allImages, tempSelected);
    const available = new Set();
    filtered.forEach(img => {
      img.products
        .filter(p => p.type === type && p.number === '0')
        .forEach(p => available.add(p.brand));
    });
    Object.entries(brandMap).forEach(([brand, imgEl]) => {
      if (available.has(brand)) {
        imgEl.classList.remove('disabled');
      } else {
        imgEl.classList.add('disabled');
      }
      if (!available.has(brand) && selected[type] === brand) {
        selected[type] = null;
        imgEl.classList.remove('selected');
      }
    });
  });
}

  function updateFilterButtons(buttons, selected, filters) {
    Object.entries(buttons).forEach(([type, data]) => {
      const { button, label, preview } = data;
      if (selected[type]) {
        const imgEl = filters[type][selected[type]];
        if (imgEl) {
          preview.src = imgEl.src;
          button.classList.add('selected');
          label.textContent = selected[type];
        }
      } else {
        button.classList.remove('selected');
        label.textContent = `Wybierz\n${type}`;
        preview.removeAttribute('src');
      }
    });
  }

function renderImages(images, productMap) {
  const collage = document.getElementById('collage');
  collage.innerHTML = '';
  images.forEach(img => {
    const container = document.createElement('div');
    container.className = 'collage-item';

    const imgEl = document.createElement('img');
    imgEl.src = img.file;
    container.appendChild(imgEl);

    const info = document.createElement('div');
    info.className = 'product-info';
    info.innerHTML = img.products
      .map(p => {
        const sizePart = p.size && p.size !== '0' ? ` ${p.size}` : '';
        const displayName = p.name === p.brand ? p.name : `${p.brand} ${p.name}`;
        const typeImage = productMap[p.type] && productMap[p.type][p.brand]
          ? `<img src="${productMap[p.type][p.brand]}" alt="">`
          : '';
        return `${typeImage}${p.type} ${displayName}${sizePart}`;
      })
      .join('<br>');
    container.appendChild(info);

    collage.appendChild(container);
  });
}

const containerUrl = 'https://buythelookstorage.blob.core.windows.net/products';
const sasToken = 'sp=rl&st=2025-09-17T12:46:16Z&se=2025-12-30T23:01:16Z&spr=https&sv=2024-11-04&sr=c&sig=iA0YjPyo%2BF28CZRzgOaJpkirTFlJM6cv76ut1xG0nKs%3D';

async function fetchFiles() {
  const url = `${containerUrl}?restype=container&comp=list&${sasToken}`;
  const res = await fetch(url);
  if (!res.ok) {
    throw new Error(`Request failed with status ${res.status}`);
  }
  const text = await res.text();
  const xml = new window.DOMParser().parseFromString(text, 'application/xml');
  return Array.from(xml.getElementsByTagName('Name')).map(n => n.textContent);
}

async function init() {
  try {
    const files = await fetchFiles();
    const images = files.map(file => {
      const parsed = parseFileName(file);
      parsed.file = `${containerUrl}/${file}?${sasToken}`;
      return parsed;
    });
    const productsByType = buildProductImageMap(images);
    const selected = {};
    const filters = {};
    const buttons = {};
    const filterContainer = document.getElementById('filters');

    Object.keys(productsByType).forEach(type => {
      const wrapper = document.createElement('div');
      wrapper.className = 'filter';
      const button = document.createElement('button');
      const preview = document.createElement('img');
      preview.className = 'preview';
      const label = document.createElement('span');
      label.className = 'label';
      label.textContent = `Wybierz\n${type}`;
      button.appendChild(preview);
      button.appendChild(label);
      const options = document.createElement('div');
      options.className = 'options';
      button.addEventListener('click', () => {
        document.querySelectorAll('#filters .filter').forEach(f => {
          if (f !== wrapper) f.classList.remove('open');
        });
        wrapper.classList.toggle('open');
      });
      wrapper.appendChild(button);
      wrapper.appendChild(options);
      filterContainer.appendChild(wrapper);
      filters[type] = {};
      selected[type] = null;
      buttons[type] = { button, label, preview };
      Object.entries(productsByType[type]).forEach(([brand, imgPath]) => {
        const imgEl = document.createElement('img');
        imgEl.src = imgPath;
        imgEl.alt = brand;
        imgEl.addEventListener('click', () => {
          if (selected[type] === brand) {
            selected[type] = null;
            imgEl.classList.remove('selected');
          } else {
            selected[type] = brand;
            Object.values(filters[type]).forEach(el => el.classList.remove('selected'));
            imgEl.classList.add('selected');
          }
          updateFilterImages(filters, images, selected);
          updateFilterButtons(buttons, selected, filters);
            const filteredImages = filterImages(images, selected);
            renderImages(filteredImages, productsByType);
          wrapper.classList.remove('open');
        });
        options.appendChild(imgEl);
        filters[type][brand] = imgEl;
      });
    });
    updateFilterImages(filters, images, selected);
    updateFilterButtons(buttons, selected, filters);
      const filteredImages = filterImages(images, selected);
      renderImages(filteredImages, productsByType);
  } catch (err) {
    console.error('Failed to load product images', err);
  }
}

init();
</script>
</body>
</html>
