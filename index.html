<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Buy The Look</title>
<style>
html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
}
body {
  display: flex;
  flex-direction: column;
}
#filters {
  display: flex;
  gap: 10px;
  padding: 10px;
  background: #f2f2f2;
  overflow-x: auto;
}
.filter {
  display: flex;
  flex-direction: column;
  align-items: center;
  font-family: sans-serif;
  font-size: 14px;
}
.filter summary {
  cursor: pointer;
}
.filter .options {
  display: none;
  gap: 5px;
  margin-top: 5px;
}
.filter[open] .options {
  display: flex;
}
.filter .options img {
  width: 120px;
  height: 120px;
  object-fit: cover;
  border: 2px solid transparent;
  cursor: pointer;
}
.filter .options img.selected {
  border-color: #007BFF;
}
.filter .options img.disabled {
  opacity: 0.3;
  pointer-events: none;
}
#main-display {
  flex: 1;
  overflow: hidden;
  display: flex;
  justify-content: center;
  align-items: center;
  position: relative;
  padding: 10px;
  background: #fff;
}
#main-display img {
  max-width: 100%;
  max-height: calc(100vh - 220px);
  width: auto;
  height: auto;
  object-fit: contain;
}
#main-display .nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.5);
  color: #fff;
  border: none;
  font-size: 24px;
  padding: 5px 10px;
  cursor: pointer;
}
#main-display .prev { left: 10px; }
#main-display .next { right: 10px; }
</style>
</head>
<body>
<div id="filters"></div>
<div id="main-display">
  <button class="nav prev">&#10094;</button>
  <img id="carousel-image" />
  <button class="nav next">&#10095;</button>
</div>
<script>
function parseFileName(file) {
  const base = file.replace(/\.[^.]+$/, '');
  const [shotId, ...productParts] = base.split('_p');
  const products = productParts.map(part => {
    const tokens = part.split('_');
    const num = tokens[0];
    let type, brand, size, name;
    if (tokens.length === 1) {
      const [id, t, b, s, ...n] = tokens[0].split('-');
      type = t; brand = b; size = s; name = n.join('-');
    } else if (tokens.length === 2) {
      const rest = tokens[1].split('-');
      type = rest[0]; brand = rest[1]; size = rest[2]; name = rest.slice(3).join('-');
    } else {
      type = tokens[1];
      const rest = tokens.slice(2).join('_').split('-');
      brand = rest[0]; size = rest[1]; name = rest.slice(2).join('-');
    }
    return { number: num, type, brand, size, name };
  });
  return { shotId, file, products };
}

function buildProductImageMap(images) {
  const map = {};
  images.forEach(img => {
    img.products.forEach(p => {
      if (!map[p.type]) map[p.type] = {};
      if (!map[p.type][p.brand]) map[p.type][p.brand] = img.file;
    });
  });
  return map;
}

function filterImages(images, selected) {
  return images.filter(img =>
    Object.entries(selected).every(([type, brand]) =>
      !brand || img.products.some(p => p.type === type && p.brand === brand)
    )
  );
}

function updateFilterImages(filters, allImages, selected) {
  Object.entries(filters).forEach(([type, brandMap]) => {
    const tempSelected = { ...selected, [type]: null };
    const filtered = filterImages(allImages, tempSelected);
    const available = new Set();
    filtered.forEach(img => {
      img.products.filter(p => p.type === type).forEach(p => available.add(p.brand));
    });
    Object.entries(brandMap).forEach(([brand, imgEl]) => {
      if (available.has(brand)) {
        imgEl.classList.remove('disabled');
      } else {
        imgEl.classList.add('disabled');
      }
      if (!available.has(brand) && selected[type] === brand) {
        selected[type] = null;
        imgEl.classList.remove('selected');
      }
    });
  });
}

let currentImages = [];
let currentIndex = 0;

function showImage() {
  const imgEl = document.getElementById('carousel-image');
  if (!currentImages.length) {
    imgEl.style.display = 'none';
    return;
  }
  imgEl.style.display = '';
  imgEl.src = currentImages[currentIndex].file;
}

function showPrev() {
  if (!currentImages.length) return;
  currentIndex = (currentIndex - 1 + currentImages.length) % currentImages.length;
  showImage();
}

function showNext() {
  if (!currentImages.length) return;
  currentIndex = (currentIndex + 1) % currentImages.length;
  showImage();
}

function renderImages(container, images) {
  currentImages = images;
  currentIndex = 0;
  showImage();
}

function init() {
  const files = [
    '20250913_p1-Torba-EvenOdd-0-EvenOdd.jpg',
    '20250913_p1-Torba-GreenBag-0-GreenBag.JPEG',
    '20250913_p1_Suknia-Czerwona-M-Czerwona-.JPEG',
    '20250913_p1_Suknia-Czerwona-M-Czerwona_p2_Torba_BrownBag-0-BrownBag.jpg',
    '20250913_p1_Suknia-Czerwona-M-Czerwona_p2_Torba_EvenOdd-0-EvenOdd.jpg',
    '20250913_p1_Suknia-Czerwona-M-Czerwona_p2_Torba_GreenBag-0-GreenBag.jpg',
    '20250913_p1_Torba-BrownBage-0-BrownBag.JPEG'
  ];
  const images = files.map(parseFileName);
  const productsByType = buildProductImageMap(images);
  const selected = {};
  const filters = {};
  const filterContainer = document.getElementById('filters');
  const mainDisplay = document.getElementById('main-display');
  mainDisplay.querySelector('.prev').addEventListener('click', showPrev);
  mainDisplay.querySelector('.next').addEventListener('click', showNext);
  let startX = null;
  mainDisplay.addEventListener('touchstart', e => {
    startX = e.touches[0].clientX;
  });
  mainDisplay.addEventListener('touchend', e => {
    if (startX === null) return;
    const diff = e.changedTouches[0].clientX - startX;
    if (diff > 50) {
      showPrev();
    } else if (diff < -50) {
      showNext();
    }
    startX = null;
  });

  Object.keys(productsByType).forEach(type => {
    const wrapper = document.createElement('details');
    wrapper.className = 'filter';
    const summary = document.createElement('summary');
    summary.textContent = type;
    const options = document.createElement('div');
    options.className = 'options';
    wrapper.appendChild(summary);
    wrapper.appendChild(options);
    filterContainer.appendChild(wrapper);
    filters[type] = {};
    selected[type] = null;
    Object.entries(productsByType[type]).forEach(([brand, imgPath]) => {
      const imgEl = document.createElement('img');
      imgEl.src = imgPath;
      imgEl.alt = brand;
      imgEl.addEventListener('click', () => {
        if (selected[type] === brand) {
          selected[type] = null;
          imgEl.classList.remove('selected');
        } else {
          selected[type] = brand;
          Object.values(filters[type]).forEach(el => el.classList.remove('selected'));
          imgEl.classList.add('selected');
        }
        updateFilterImages(filters, images, selected);
        const filteredImages = filterImages(images, selected);
        renderImages(document.getElementById('main-display'), filteredImages);
      });
      options.appendChild(imgEl);
      filters[type][brand] = imgEl;
    });
  });
  updateFilterImages(filters, images, selected);
  const filteredImages = filterImages(images, selected);
  renderImages(document.getElementById('main-display'), filteredImages);
}

init();
</script>
</body>
</html>
