<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Buy The Look</title>
<style>
html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
}
body {
  display: flex;
  flex-direction: column;
}
  #filters {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: #f2f2f2;
      position: relative;
      z-index: 1000;
      overflow: visible;
    }
  .filter {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: sans-serif;
    font-size: 14px;
  }
    .filter button {
      background: none;
      border: none;
      cursor: pointer;
      font: inherit;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .filter button img {
      width: 20px;
      height: 20px;
      object-fit: cover;
    }
  .filter .options {
    display: none;
    gap: 5px;
    position: absolute;
    top: 100%;
    left: 0;
    background: #fff;
    flex-direction: column;
    max-height: calc(100vh - 100px);
    overflow-y: auto;
    padding: 10px;
    width: 150px;
    z-index: 1001;
  }
  .filter.open .options {
    display: flex;
  }
.filter .options img {
  width: 120px;
  height: 120px;
  object-fit: cover;
  border: 2px solid transparent;
  cursor: pointer;
}
.filter .options img.selected {
  border-color: #007BFF;
}
.filter .options img.disabled {
  opacity: 0.3;
  pointer-events: none;
}
#main-display {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 10px;
  background: #fff;
  position: relative;
  z-index: 1;
}
#collage {
  column-count: 3;
  column-gap: 10px;
}
#collage img {
  width: 100%;
  height: auto;
  margin-bottom: 10px;
  display: block;
}
</style>
</head>
<body>
<div id="filters"></div>
<div id="main-display">
  <div id="collage"></div>
</div>
<script>
function parseFileName(file) {
  const base = file.replace(/\.[^.]+$/, '');
  const [shotId, ...productParts] = base.split('_p');
  const products = productParts.map(part => {
    const tokens = part.split('_');
    const num = tokens[0];
    let type, brand, size, name;
    if (tokens.length === 1) {
      const [id, t, b, s, ...n] = tokens[0].split('-');
      type = t; brand = b; size = s; name = n.join('-');
    } else if (tokens.length === 2) {
      const rest = tokens[1].split('-');
      type = rest[0]; brand = rest[1]; size = rest[2]; name = rest.slice(3).join('-');
    } else {
      type = tokens[1];
      const rest = tokens.slice(2).join('_').split('-');
      brand = rest[0]; size = rest[1]; name = rest.slice(2).join('-');
    }
    return { number: num, type, brand, size, name };
  });
  return { shotId, file, products };
}

function buildProductImageMap(images) {
  const map = {};
  images.forEach(img => {
    if (img.products.length !== 1) return;
    const p = img.products[0];
    if (!map[p.type]) map[p.type] = {};
    map[p.type][p.brand] = img.file;
  });
  return map;
}

function filterImages(images, selected) {
  return images.filter(img =>
    Object.entries(selected).every(([type, brand]) =>
      !brand || img.products.some(p => p.type === type && p.brand === brand)
    )
  );
}

function updateFilterImages(filters, allImages, selected) {
  Object.entries(filters).forEach(([type, brandMap]) => {
    const tempSelected = { ...selected, [type]: null };
    const filtered = filterImages(allImages, tempSelected);
    const available = new Set();
    filtered.forEach(img => {
      img.products.filter(p => p.type === type).forEach(p => available.add(p.brand));
    });
    Object.entries(brandMap).forEach(([brand, imgEl]) => {
      if (available.has(brand)) {
        imgEl.classList.remove('disabled');
      } else {
        imgEl.classList.add('disabled');
      }
      if (!available.has(brand) && selected[type] === brand) {
        selected[type] = null;
        imgEl.classList.remove('selected');
      }
    });
  });
}

  function updateFilterButtons(buttons, selected, filters) {
    Object.entries(buttons).forEach(([type, data]) => {
      const { button, label, preview } = data;
      if (selected[type]) {
        label.textContent = `${type}: ${selected[type]}`;
        const imgEl = filters[type][selected[type]];
        if (imgEl) {
          preview.src = imgEl.src;
          preview.style.display = 'inline';
        }
      } else {
        label.textContent = type;
        preview.style.display = 'none';
      }
    });
  }

function renderImages(images) {
  const collage = document.getElementById('collage');
  collage.innerHTML = '';
  images.forEach(img => {
    const imgEl = document.createElement('img');
    imgEl.src = img.file;
    collage.appendChild(imgEl);
  });
}

function init() {
  const files = [
    '20250913_p1-Torba-EvenOdd-0-EvenOdd.jpg',
    '20250913_p1-Torba-GreenBag-0-GreenBag.JPEG',
    '20250913_p1_Suknia-Czerwona-M-Czerwona-.JPEG',
    '20250913_p1_Suknia-Czerwona-M-Czerwona_p2_Torba_BrownBag-0-BrownBag.jpg',
    '20250913_p1_Suknia-Czerwona-M-Czerwona_p2_Torba_EvenOdd-0-EvenOdd.jpg',
    '20250913_p1_Suknia-Czerwona-M-Czerwona_p2_Torba_GreenBag-0-GreenBag.jpg',
    '20250913_p1_Torba-BrownBag-0-BrownBag.JPEG'
  ];
  const images = files.map(parseFileName);
  const productsByType = buildProductImageMap(images);
  const selected = {};
  const filters = {};
  const buttons = {};
  const filterContainer = document.getElementById('filters');

  Object.keys(productsByType).forEach(type => {
    const wrapper = document.createElement('div');
    wrapper.className = 'filter';
    const button = document.createElement('button');
    const preview = document.createElement('img');
    preview.style.display = 'none';
    const label = document.createElement('span');
    label.textContent = type;
    button.appendChild(preview);
    button.appendChild(label);
    const options = document.createElement('div');
    options.className = 'options';
    button.addEventListener('click', () => {
      document.querySelectorAll('#filters .filter').forEach(f => {
        if (f !== wrapper) f.classList.remove('open');
      });
      wrapper.classList.toggle('open');
    });
    wrapper.appendChild(button);
    wrapper.appendChild(options);
    filterContainer.appendChild(wrapper);
    filters[type] = {};
    selected[type] = null;
    buttons[type] = { button, label, preview };
    Object.entries(productsByType[type]).forEach(([brand, imgPath]) => {
      const imgEl = document.createElement('img');
      imgEl.src = imgPath;
      imgEl.alt = brand;
      imgEl.addEventListener('click', () => {
        if (selected[type] === brand) {
          selected[type] = null;
          imgEl.classList.remove('selected');
        } else {
          selected[type] = brand;
          Object.values(filters[type]).forEach(el => el.classList.remove('selected'));
          imgEl.classList.add('selected');
        }
        updateFilterImages(filters, images, selected);
        updateFilterButtons(buttons, selected, filters);
        const filteredImages = filterImages(images, selected);
        renderImages(filteredImages);
        wrapper.classList.remove('open');
      });
      options.appendChild(imgEl);
      filters[type][brand] = imgEl;
    });
  });
  updateFilterImages(filters, images, selected);
  updateFilterButtons(buttons, selected, filters);
  const filteredImages = filterImages(images, selected);
  renderImages(filteredImages);
}

init();
</script>
</body>
</html>
