<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Buy The Look</title>
<style>
html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
}
body {
  display: flex;
  flex-direction: column;
}
#filters {
  display: flex;
  gap: 10px;
  padding: 10px;
  background: #f2f2f2;
  overflow-x: auto;
}
#filters label {
  display: flex;
  flex-direction: column;
  font-family: sans-serif;
  font-size: 14px;
}
#main-display {
  flex: 1;
  overflow-y: auto;
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  align-content: flex-start;
  gap: 10px;
  padding: 10px;
  background: #fff;
}
#main-display img {
  max-width: 100%;
  height: auto;
  object-fit: contain;
}
</style>
</head>
<body>
<div id="filters"></div>
<div id="main-display"></div>
<script>
async function getImageFiles() {
  const res = await fetch('.');
  const text = await res.text();
  const parser = new DOMParser();
  const doc = parser.parseFromString(text, 'text/html');
  return Array.from(doc.querySelectorAll('a'))
    .map(a => a.getAttribute('href'))
    .filter(href => href && href.match(/\.jpe?g$/i));
}

function parseFileName(file) {
  const base = file.replace(/\.[^.]+$/, '');
  const [shotId, ...productParts] = base.split('_p');
  const products = productParts.map(part => {
    const tokens = part.split('_');
    const num = tokens[0];
    let type, brand, size, name;
    if (tokens.length === 1) {
      const [id, t, b, s, ...n] = tokens[0].split('-');
      type = t; brand = b; size = s; name = n.join('-');
    } else if (tokens.length === 2) {
      const rest = tokens[1].split('-');
      type = rest[0]; brand = rest[1]; size = rest[2]; name = rest.slice(3).join('-');
    } else {
      type = tokens[1];
      const rest = tokens.slice(2).join('_').split('-');
      brand = rest[0]; size = rest[1]; name = rest.slice(2).join('-');
    }
    return { number: num, type, brand, size, name };
  });
  return { shotId, file, products };
}

function buildProductsByType(images) {
  const map = {};
  images.forEach(img => {
    img.products.forEach(p => {
      if (!map[p.type]) map[p.type] = new Set();
      map[p.type].add(p.brand);
    });
  });
  return map;
}

function filterImages(images, selected) {
  return images.filter(img =>
    Object.entries(selected).every(([type, brand]) =>
      !brand || img.products.some(p => p.type === type && p.brand === brand)
    )
  );
}

function updateFilterOptions(filters, allImages, selected) {
  Object.entries(filters).forEach(([type, select]) => {
    const tempSelected = { ...selected, [type]: null };
    const filtered = filterImages(allImages, tempSelected);
    const options = new Set();
    filtered.forEach(img => {
      img.products.filter(p => p.type === type).forEach(p => options.add(p.brand));
    });
    const current = selected[type];
    select.innerHTML = '<option value="">All</option>' +
      Array.from(options).map(o => `<option value="${o}">${o}</option>`).join('');
    if (current && options.has(current)) {
      select.value = current;
    } else {
      select.value = '';
      selected[type] = null;
    }
  });
}

function renderImages(container, images) {
  container.innerHTML = '';
  images.forEach(img => {
    const el = document.createElement('img');
    el.src = img.file;
    container.appendChild(el);
  });
}

async function init() {
  const files = await getImageFiles();
  const images = files.map(parseFileName);
  const productsByType = buildProductsByType(images);
  const selected = {};
  const filters = {};
  const filterContainer = document.getElementById('filters');
  Object.keys(productsByType).forEach(type => {
    const label = document.createElement('label');
    label.textContent = type;
    const select = document.createElement('select');
    select.addEventListener('change', () => {
      selected[type] = select.value || null;
      updateFilterOptions(filters, images, selected);
      const filteredImages = filterImages(images, selected);
      renderImages(document.getElementById('main-display'), filteredImages);
    });
    label.appendChild(select);
    filterContainer.appendChild(label);
    filters[type] = select;
    selected[type] = null;
  });
  updateFilterOptions(filters, images, selected);
  const filteredImages = filterImages(images, selected);
  renderImages(document.getElementById('main-display'), filteredImages);
}

init();
</script>
</body>
</html>
